\section{Optimizing applications}

\begin{frame}
\frametitle{Measuring: strace}
\begin{itemize}
	\item Allows to trace all the system calls made by an
              application and its children.
	\item Useful to:
	\begin{itemize}
		\item Understand how time is spent in user space
		\item For example, easy to find file open attempts (\code{open()}),
		      file access (\code{read()}, \code{write()}), and
		      memory allocations (\code{mmap2()}). Can be done
		      without any access to source code!
		\item Find the biggest time consumers
		      (low hanging fruit)
		\item Find unnecessary work done in applications
		      and scripts. Example: opening the same file(s)
		      multiple times, or trying to open files that
		      do not exist.
	\end{itemize}
	\item Limitation: you can't trace the \code{init} process!
\end{itemize}
\end{frame}

\input{../common/strace.tex}
\input{../common/ltrace.tex}
\input{../common/valgrind.tex}

\begin{frame}[fragile]
\frametitle{perf}
\begin{itemize}
	\item Uses hardware performance counters
	\item \kconfig{CONFIG_PERF_EVENTS} and \kconfig{CONFIG_HW_PERF_EVENTS}
	\item User space tool: \code{perf}. It is part of the kernel
		sources so it is always in sync with your kernel.
	\item Usage:
	\begin{block}{}
\begin{verbatim}
perf record /my/command
\end{verbatim}
	\end{block}
	\item Get the results with:
	\begin{block}{}
\begin{verbatim}
perf report
\end{verbatim}
	\end{block}
\end{itemize}
\end{frame}

\begin{frame}[fragile]
\frametitle{perf}
\begin{block}{}
\tiny
\begin{verbatim}
    20.91%  gst-launch-0.10  libavcodec.so.53.35.0        [.] 0x00000000003bdaa1
    15.45%  gst-launch-0.10  libgstflump3dec.so           [.] 0x0000000000014b42
     3.16%  gst-launch-0.10  libglib-2.0.so.0.3600.2      [.] 0x00000000000882c9
     2.99%  gst-launch-0.10  libc-2.17.so                 [.] __memcpy_ssse3_back
     2.37%  gst-launch-0.10  liboil-0.3.so.0.3.0          [.] 0x000000000004417e
     2.24%  gst-launch-0.10  libgobject-2.0.so.0.3600.2   [.] g_type_value_table_peek
     1.53%  gst-launch-0.10  libc-2.17.so                 [.] vfprintf
     1.37%  gst-launch-0.10  libgstreamer-0.10.so.0.30.0  [.] 0x0000000000026fd8
     1.29%  gst-launch-0.10  ld-2.17.so                   [.] do_lookup_x
     0.99%  gst-launch-0.10  libpthread-2.17.so           [.] pthread_mutex_lock
     0.98%  gst-launch-0.10  libgobject-2.0.so.0.3600.2   [.] g_type_check_value
     0.93%  gst-launch-0.10  libgstavi.so                 [.] 0x00000000000119f9
     0.88%  gst-launch-0.10  libgstreamer-0.10.so.0.30.0  [.] gst_value_list_get_type
     0.85%  gst-launch-0.10  libc-2.17.so                 [.] __random
     0.66%  gst-launch-0.10  [kernel.kallsyms]            [k] clear_page_c_e
     0.62%  gst-launch-0.10  [kernel.kallsyms]            [k] try_to_wake_up
     0.61%  gst-launch-0.10  [kernel.kallsyms]            [k] page_fault
     0.58%  gst-launch-0.10  libgobject-2.0.so.0.3600.2   [.] g_type_is_a
     0.57%  gst-launch-0.10  libc-2.17.so                 [.] __strcmp_sse42
     0.57%  gst-launch-0.10  [kernel.kallsyms]            [k] radix_tree_lookup_element
     0.57%  gst-launch-0.10  libc-2.17.so                 [.] malloc
     0.57%  gst-launch-0.10  libc-2.17.so                 [.] _int_malloc
     0.55%  gst-launch-0.10  libgobject-2.0.so.0.3600.2   [.] g_type_check_instance_is_a
     0.53%  gst-launch-0.10  [kernel.kallsyms]            [k] __ticket_spin_lock
     0.53%  gst-launch-0.10  libgobject-2.0.so.0.3600.2   [.] g_type_check_value_holds
     0.53%  gst-launch-0.10  libgstffmpeg.so              [.] 0x000000000001e40c
     0.51%  gst-launch-0.10  libgstreamer-0.10.so.0.30.0  [.] gst_structure_id_get_value
     0.50%  gst-launch-0.10  libc-2.17.so                 [.] _IO_default_xsputn
     0.50%  gst-launch-0.10  [kernel.kallsyms]            [k] tg_load_down
\end{verbatim}
\end{block}
\end{frame}

\setuplabframe
{Optimizing the application}
{
\begin{itemize}
\item Compile the video player with just the features needed at run
      time.
\item Trace and profile the video player with \code{strace}
\item Observe size and time savings
\end{itemize}
}

